/*!
 * maptalks.routeplayer v0.1.0
 * LICENSE : MIT
 * (c) 2016-2023 maptalks.org
 */
/*!
 * requires maptalks@^1.0.0-rc.18 
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,y){"use strict";var e=function(t,e,i){return e&&r(t.prototype,e),i&&r(t,i),t};function r(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);if(t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e)if(Object.setPrototypeOf)Object.setPrototypeOf(t,e);else for(var i=t,r=e,n=Object.getOwnPropertyNames(r),o=0;o<n.length;o++){var a=n[o],s=Object.getOwnPropertyDescriptor(r,a);s&&s.configurable&&void 0===i[a]&&Object.defineProperty(i,a,s)}}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var m=new y.Coordinate([0,0,0]),a=(o.prototype.getCoordinates=function(t,e){if(t<this.getStart()||t>this.getEnd())return null;for(var i=null,r=null,n=0,o=this.path.length;n<o;n++)if(t<this.path[n][3]){i=n,r=this.path[n][4];break}null===i&&(i=this.path.length-1);var a=this.path[i-1],s=this.path[i],l=(t-a[3])/(s[3]-a[3]),p=a[0]+(s[0]-a[0])*l,h=a[1]+(s[1]-a[1])*l,s=a[2]+(s[2]-a[2])*l,l=e.getGLRes(),u=(m.x=p,m.y=h,m.z=s,e.coordinateToPointAtRes(m,l)),a=(m.x=a[0],m.y=a[1],m.z=a[2],e.coordinateToPointAtRes(m,l)),e=y.Util.computeDegree(a.x,a.y,u.x,u.y);return{coordinate:new y.Coordinate(p,h,s),viewPoint:u,degree:e,index:i,payload:r}},o.prototype.getStart=function(){return this.path[0][3]},o.prototype.getEnd=function(){return this.path[this.getCount()-1][3]},o.prototype.getCount=function(){return this.path.length},e(o,[{key:"markerSymbol",get:function(){return this.route.markerSymbol},set:function(t){this.route.markerSymbol=t,this._painter&&this._painter.marker&&this._painter.marker.setSymbol(t)}},{key:"lineSymbol",get:function(){return this.route.lineSymbol},set:function(t){this.route.lineSymbol=t,this._painter&&this._painter.marker&&this._painter.line.setSymbol(t)}},{key:"trailLineSymbol",get:function(){return this.route.trailLineSymbol},set:function(t){this.route.trailLineSymbol=t,this._painter&&this._painter.marker&&this._painter.trailLine.setSymbol(t)}}]),o);function o(t){n(this,o),this.route=t,this.path=t.path}i(l,s=y.Eventable(y.Class)),l.prototype.remove=function(){return this.markerLayer&&(this.finish(),this.markerLayer.remove(),this.lineLayer.remove(),this.trailLineLayer.remove(),delete this.markerLayer,delete this.lineLayer,delete this.trailLineLayer,delete this._map),this},l.prototype.play=function(){return"running"!==this.player.playState&&(this.player.play(),this.fire("playstart")),this},l.prototype.pause=function(){return"paused"!==this.player.playState&&(this.player.pause(),this.fire("playpause")),this},l.prototype.cancel=function(){this.player.cancel(),this.played=0,this.trailLinePoints=[];var t=this.trailLineLayer.getGeometries()[0];return void 0!==t&&t.setCoordinates(this.trailLinePoints),this._createPlayer(),this._step({styles:{t:0}}),this.fire("playcancel"),this},l.prototype.finish=function(){var t,e;return"finished"!==this.player.playState&&(t=this.trailLineLayer.getGeometries()[0],e=this.routes[0].path.map(function(t){return[t[0],t[1]]}),this.trailLinePoints=e,t.setCoordinates(this.trailLinePoints),this.player.finish(),this._step({styles:{t:1}}),this.fire("playfinish")),this},l.prototype.getStartTime=function(){return this.startTime||0},l.prototype.getEndTime=function(){return this.endTime||0},l.prototype.getCurrentTime=function(){return this.played?this.startTime+this.played:this.startTime},l.prototype.getRoutes=function(){return this.routes},l.prototype.setTime=function(t){return this.played=t-this.startTime,this.played<0&&(this.played=0),this._resetPlayer(),this},l.prototype.getUnitTime=function(){return this.options.unitTime},l.prototype.setUnitTime=function(t){this.options.unitTime=+t,this._resetPlayer()},l.prototype.getCurrentProperties=function(t){return this.routes[t=t||0]&&this.routes[t]._painter?this.routes[t]._painter.marker.getProperties():null},l.prototype.getCurrentCoordinates=function(t){return this.routes[t=t||0]&&this.routes[t]._painter?this.routes[t]._painter.marker.getCoordinates():null},l.prototype.getMarkerSymbol=function(t){return this.routes&&this.routes[t]?this.routes[t].markerSymbol:null},l.prototype.getMarker=function(t){return this.routes[t=t||0]&&this.routes[t]._painter?this.routes[t]._painter.marker:null},l.prototype.setMarkerSymbol=function(t,e){return this.routes&&this.routes[t]&&(this.routes[t].markerSymbol=e),this},l.prototype.getLineSymbol=function(t){return this.routes&&this.routes[t]?this.routes[t].lineSymbol:null},l.prototype.setLineSymbol=function(t,e){return this.routes&&this.routes[t]&&(this.routes[t].lineSymbol=e),this},l.prototype.showRoute=function(){this.lineLayer.show()},l.prototype.showTrail=function(){this.trailLineLayer.show()},l.prototype.hideRoute=function(){this.lineLayer.hide()},l.prototype.hideTrail=function(){this.trailLineLayer.hide()},l.prototype._resetPlayer=function(){var t=this.player&&"running"===this.player.playState;t&&this.player.finish(),this._createPlayer(),t&&this.player.play()},l.prototype._step=function(t){if(t.state&&"running"!==t.state.playState)"finished"===t.state.playState&&this.fire("playfinish");else{this.played=this.duration*t.styles.t;for(var e=0,i=this.routes.length;e<i;e++)this._drawRoute(this.routes[e],this.startTime+this.played);var r,n,t=this._calPositions();t&&(r=t.rotationX,n=t.rotationZ,t=t.coordinate,this.fire("playing",{rotationX:r,rotationZ:n,coordinate:t,time:this.played}))}},l.prototype._drawRoute=function(t,e){var i;this._map&&((e=t.getCoordinates(e,this._map))?(t._painter||(t._painter={}),t._painter.marker?(t._painter.marker.setProperties(e.payload),t._painter.marker.setCoordinates(e.coordinate)):(i=new y.Marker(e.coordinate,{symbol:t.markerSymbol||this.options.markerSymbol}).addTo(this.markerLayer),t._painter.marker=i),t._painter.line||(i=t.path.map(function(t){return t[2]}),i=new y.LineString(t.path,{symbol:t.lineSymbol||this.options.lineSymbol,properties:{altitude:i}}).addTo(this.lineLayer),t._painter.line=i),t._painter.trailLine?(0!==(i=this.options.maxTrailLine)&&this.trailLinePoints.length>i&&(this.trailLinePoints.shift(),t._painter.trailLine.getProperties().altitude.shift()),this.trailLinePoints.push(e.coordinate),1<this.trailLinePoints.length&&(t._painter.trailLine.setCoordinates(this.trailLinePoints),t._painter.trailLine.getProperties().altitude.push(e.altitude))):(this.trailLinePoints=[e.coordinate],i=new y.LineString([],{symbol:t.trailLineSymbol||this.options.trailLineSymbol,properties:{altitude:[e.altitude]}}).addTo(this.trailLineLayer),t._painter.trailLine=i)):t._painter&&t._painter.marker&&(t._painter.marker.remove(),delete t._painter.marker))},l.prototype._calPositions=function(){var t,e,i,r,n,o,a;if(this.trailLinePoints&&1<this.trailLinePoints.length)return e=this.trailLinePoints.length,t=this.trailLinePoints[e-1],e=this.trailLinePoints[e-2],o=this._map.getGLRes(),a=this._map.coordinateToPointAtRes(t,o),n=this._map.coordinateToPointAtRes(e,o),i=y.Util.computeDegree(a.x,a.y,n.x,n.y),r=this._map.altitudeToPoint(t.z,o),o=this._map.altitudeToPoint(e.z,o),n=y.Util.computeDegree(n.x,o,a.x,r),o=i/Math.PI*180,a=n/Math.PI*180,t.x>=e.x?a=-a:a+=180,{rotationZ:o,rotationX:a,coordinate:t}},l.prototype._setup=function(t){for(var e=t.map(function(t){return new a(t)}),i=e[0].getStart(),r=e[0].getEnd(),n=1;n<e.length;n++){var o=e[n];o.getStart()<i&&(i=o.getStart()),o.getEnd()>r&&(r=o.getEnd())}this.trailLinePoints=[],this.routes=e,this.startTime=i,this.endTime=r,this.played=0,this.duration=r-i,this._createLayers(),this._createPlayer()},l.prototype._createPlayer=function(){var t=(this.duration-this.played)/this.options.unitTime,e=void 0,i=this._map._getRenderer();i.callInFrameLoop&&(e=function(t){i.callInFrameLoop(t)}),this.player=y.animation.Animation.animate({t:[this.played/this.duration,1]},{framer:e,speed:t,easing:"linear"},this._step.bind(this))},l.prototype._createLayers=function(){this.lineLayer=new y.VectorLayer(y.INTERNAL_LAYER_PREFIX+"_routeplay_r_"+this.id,[],{visible:this.options.showRoutes,enableSimplify:!1,enableAltitude:!0}).addTo(this._map),this.trailLineLayer=new y.VectorLayer(y.INTERNAL_LAYER_PREFIX+"_routeplay_t_"+this.id,[],{visible:this.options.showTrail,enableSimplify:!1,enableAltitude:!0}).addTo(this._map),this.markerLayer=new y.VectorLayer(y.INTERNAL_LAYER_PREFIX+"_routeplay_m_"+this.id).addTo(this._map)};var s,e=l;function l(t,e,i){n(this,l);i=function(t,e){if(t)return!e||"object"!=typeof e&&"function"!=typeof e?t:e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(this,s.call(this,i));return Array.isArray(t)||(t=[t]),i.id=y.Util.UID(),i._map=e,i._setup(t),i}e.mergeOptions({unitTime:1e3,showRoutes:!0,showTrail:!0,maxTrailLine:0,markerSymbol:null,lineSymbol:{lineWidth:2,lineColor:"#004A8D"},trailLineSymbol:{lineColor:"rgba(250,0,0,1)",lineWidth:4,lineJoin:"round",lineCap:"round",lineDasharray:null,"lineOpacity ":1}}),t.Route=a,t.RoutePlayer=e,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.routeplayer v0.1.0, requires maptalks@^1.0.0-rc.18.")});