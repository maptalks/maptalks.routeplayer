/*!
 * maptalks.routeplayer v0.1.0
 * LICENSE : MIT
 * (c) 2016-2022 maptalks.org
 */
/*!
 * requires maptalks@^0.23.0 
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,f){"use strict";var e=function(t,e,i){return e&&r(t.prototype,e),i&&r(t,i),t};function r(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):function(t,e){for(var i=Object.getOwnPropertyNames(e),r=0;r<i.length;r++){var n=i[r],o=Object.getOwnPropertyDescriptor(e,n);o&&o.configurable&&void 0===t[n]&&Object.defineProperty(t,n,o)}}(t,e))}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var a=(o.prototype.getCoordinates=function(t,e){if(t<this.getStart()||t>this.getEnd())return null;for(var i=null,r=null,n=0,o=this.path.length;n<o;n++)if(t<this.path[n][2]){i=n,r=this.path[n][3];break}null===i&&(i=this.path.length-1);var a=this.path[i-1],s=this.path[i],l=(t-a[2])/(s[2]-a[2]),h=a[0]+(s[0]-a[0])*l,p=a[1]+(s[1]-a[1])*l,u=new f.Coordinate(h,p),y=e.coordinateToViewPoint(u);return{coordinate:u,viewPoint:y,degree:f.Util.computeDegree(e.coordinateToViewPoint(new f.Coordinate(a)),y),index:i,payload:r}},o.prototype.getStart=function(){return this.path[0][2]},o.prototype.getEnd=function(){return this.path[this.getCount()-1][2]},o.prototype.getCount=function(){return this.path.length},e(o,[{key:"markerSymbol",get:function(){return this.route.markerSymbol},set:function(t){this.route.markerSymbol=t,this._painter&&this._painter.marker&&this._painter.marker.setSymbol(t)}},{key:"lineSymbol",get:function(){return this.route.lineSymbol},set:function(t){this.route.lineSymbol=t,this._painter&&this._painter.marker&&this._painter.line.setSymbol(t)}},{key:"trailLineSymbol",get:function(){return this.route.trailLineSymbol},set:function(t){this.route.trailLineSymbol=t,this._painter&&this._painter.marker&&this._painter.trailLine.setSymbol(t)}}]),o);function o(t){n(this,o),this.route=t,this.path=t.path}function l(t){return t%360*Math.PI/180}function s(t,e){var i=l(t.x||t[0]),r=l(t.y||t[1]),n=l(e.x||e[0]),o=l(e.y||e[1]),a=Math.sin(n-i)*Math.cos(o),s=Math.cos(r)*Math.sin(o)-Math.sin(r)*Math.cos(o)*Math.cos(n-i);return Math.atan2(a,s)%(2*Math.PI)*180/Math.PI}var h,p=(i(u,h=f.Eventable(f.Class)),u.prototype.remove=function(){return this.markerLayer&&(this.finish(),this.markerLayer.remove(),this.lineLayer.remove(),this.trailLineLayer.remove(),delete this.markerLayer,delete this.lineLayer,delete this.trailLineLayer,delete this._map),this},u.prototype.play=function(){return"running"===this.player.playState||(this.player.play(),this._follow&&this._setFollowView(),this.fire("playstart")),this},u.prototype.pause=function(){return"paused"===this.player.playState||(this.player.pause(),this.fire("playpause")),this},u.prototype.cancel=function(){this.player.cancel(),this.played=0,this.trailLinePoints=[];var t=this.trailLineLayer.getGeometries()[0];return void 0!==t&&t.setCoordinates(this.trailLinePoints),this._createPlayer(),this._step({styles:{t:0}}),this.fire("playcancel"),this},u.prototype.finish=function(){if("finished"===this.player.playState)return this;var t=this.trailLineLayer.getGeometries()[0],e=this.routes[0].path.map(function(t){return[t[0],t[1]]});return this.trailLinePoints=e,t.setCoordinates(this.trailLinePoints),this.player.finish(),this._step({styles:{t:1}}),this.fire("playfinish"),this},u.prototype.getStartTime=function(){return this.startTime||0},u.prototype.getEndTime=function(){return this.endTime||0},u.prototype.getCurrentTime=function(){return this.played?this.startTime+this.played:this.startTime},u.prototype.setTime=function(t){return this.played=t-this.startTime,this.played<0&&(this.played=0),this._resetPlayer(),this},u.prototype.getUnitTime=function(){return this.options.unitTime},u.prototype.setUnitTime=function(t){this.options.unitTime=+t,this._resetPlayer()},u.prototype.getCurrentProperties=function(t){return t=t||0,this.routes[t]&&this.routes[t]._painter?this.routes[t]._painter.marker.getProperties():null},u.prototype.getCurrentCoordinates=function(t){return t=t||0,this.routes[t]&&this.routes[t]._painter?this.routes[t]._painter.marker.getCoordinates():null},u.prototype.getMarkerSymbol=function(t){return this.routes&&this.routes[t]?this.routes[t].markerSymbol:null},u.prototype.setMarkerSymbol=function(t,e){return this.routes&&this.routes[t]&&(this.routes[t].markerSymbol=e),this},u.prototype.getLineSymbol=function(t){return this.routes&&this.routes[t]?this.routes[t].lineSymbol:null},u.prototype.setLineSymbol=function(t,e){return this.routes&&this.routes[t]&&(this.routes[t].lineSymbol=e),this},u.prototype.showRoute=function(){this.lineLayer.show()},u.prototype.showTrail=function(){this.trailLineLayer.show()},u.prototype.hideRoute=function(){this.lineLayer.hide()},u.prototype.hideTrail=function(){this.trailLineLayer.hide()},u.prototype.enableFollow=function(){this._setFollowView(),this._follow=!0},u.prototype.disabledFollow=function(){this._follow=!1,this._map.setPitch(this._historyConfig.pitch)},u.prototype._resetPlayer=function(){var t=this.player&&"running"===this.player.playState;t&&this.player.finish(),this._createPlayer(),t&&this.player.play()},u.prototype._step=function(t){if(t.state&&"running"!==t.state.playState)"finished"===t.state.playState&&this.fire("playfinish");else{this.played=this.duration*t.styles.t;for(var e=0,i=this.routes.length;e<i;e++)this._drawRoute(this.routes[e],this.startTime+this.played);this.fire("playing")}},u.prototype._drawRoute=function(t,e){if(this._map){var i=t.getCoordinates(e,this._map);if(i){if(t._painter||(t._painter={}),t._painter.marker)t._painter.marker.setProperties(i.payload),t._painter.marker.setCoordinates(i.coordinate);else{var r=new f.Marker(i.coordinate,{symbol:t.markerSymbol||this.options.markerSymbol}).addTo(this.markerLayer);t._painter.marker=r}if(!t._painter.line){var n=new f.LineString(t.path,{symbol:t.lineSymbol||this.options.lineSymbol}).addTo(this.lineLayer);t._painter.line=n}if(t._painter.trailLine){var o=this.options.maxTrailLine;0!==o&&this.trailLinePoints.length>o&&this.trailLinePoints.shift(),this.trailLinePoints.push(i.coordinate),1<this.trailLinePoints.length&&t._painter.trailLine.setCoordinates(this.trailLinePoints)}else{this.trailLinePoints=[i.coordinate];var a=new f.LineString([],{symbol:t.trailLineSymbol||this.options.trailLineSymbol}).addTo(this.trailLineLayer);t._painter.trailLine=a}this._follow&&this._perspectiveFollow(),this._preCoordinate=i.coordinate}else t._painter&&t._painter.marker&&(t._painter.marker.remove(),delete t._painter.marker)}},u.prototype._perspectiveFollow=function(){var t=this.getCurrentCoordinates();if(this._preCoordinate&&t){var e=this._map,i=this._getBearing(this._preCoordinate,t);e.setCenter(t),e.setBearing(i)}},u.prototype._setFollowView=function(){this._map.setZoom(17),this._map.setPitch(65)},u.prototype._getBearing=function(t,e){var i=s(t,e),r=this._map.getBearing();return Math.abs(r-i)<30?r:i},u.prototype._setup=function(t){for(var e=t.map(function(t){return new a(t)}),i=e[0].getStart(),r=e[0].getEnd(),n=1;n<e.length;n++){var o=e[n];o.getStart()<i&&(i=o.getStart()),o.getEnd()>r&&(r=o.getEnd())}this.trailLinePoints=[],this.routes=e,this.startTime=i,this.endTime=r,this.played=0,this.duration=r-i,this._createLayers(),this._createPlayer()},u.prototype._createPlayer=function(){var t=(this.duration-this.played)/this.options.unitTime,e=void 0,i=this._map._getRenderer();i.callInFrameLoop&&(e=function(t){i.callInFrameLoop(t)}),this.player=f.animation.Animation.animate({t:[this.played/this.duration,1]},{framer:e,speed:t,easing:"linear"},this._step.bind(this))},u.prototype._createLayers=function(){this.lineLayer=new f.VectorLayer(f.INTERNAL_LAYER_PREFIX+"_routeplay_r_"+this.id,[],{visible:this.options.showRoutes,enableSimplify:!1}).addTo(this._map),this.trailLineLayer=new f.VectorLayer(f.INTERNAL_LAYER_PREFIX+"_routeplay_t_"+this.id,[],{visible:this.options.showTrail,enableSimplify:!1}).addTo(this._map),this.markerLayer=new f.VectorLayer(f.INTERNAL_LAYER_PREFIX+"_routeplay_m_"+this.id).addTo(this._map)},u);function u(t,e,i){n(this,u);var r=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,h.call(this,i));return Array.isArray(t)||(t=[t]),r.id=f.Util.UID(),r._map=e,r._follow=i.perspectiveFollow,r._historyConfig={},r._setup(t),r}p.mergeOptions({unitTime:1e3,showRoutes:!0,showTrail:!0,maxTrailLine:0,markerSymbol:null,lineSymbol:{lineWidth:2,lineColor:"#004A8D"},trailLineSymbol:{lineColor:"rgba(250,0,0,1)",lineWidth:4,lineJoin:"round",lineCap:"round",lineDasharray:null,"lineOpacity ":1}}),t.Route=a,t.RoutePlayer=p,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.routeplayer v0.1.0, requires maptalks@^0.23.0.")});